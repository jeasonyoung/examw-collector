<#--科目设置列表--> <#include "ftl/comm.ftl"/> <#assign
module="update_subject"/> <#assign dg="${module}_list_dg"/>
<script type="text/javascript">
<!--
	$(function() {
		var current_catalog_id = "";
		//catalog-exam-tree
		var t = $("#${module}_list_catalog_exam_tree").tree({
			url : "<@s.url '/admin/local/catalog/tree'/>",
			onLoadError : function(e) {
				<@error_dialog "e"/>
			},
			onBeforeLoad : function() {
				current_catalog_id = "";
			},
			onClick : function(node) {
				if (node.attributes && node.attributes.code)
					current_catalog_id = node.attributes.code;
				//search;
				${dg}_search();
			}
		});
		var dg1 = $("#${dg}_remote").datagrid({
			url:"<@s.url '/admin/update/subject/datagrid'/>",
			fit : true,
			fitColumns : true,
			rownumbers : true,
			border : true,
			striped : true,
			idField : "code",
			columns:[[{
				field:"children",
				checkbox:true
			},{
				title:"科目名称",
				field:"name",
				width:25
			},{
				title:"科目代码",
				field:"code",
				width:15
			},{
				title:"所属类别",
				field:"catalogName",
				width:35
			},{
				title:"状态",
				field:"status",
				width:35
			}]],
			toolbar : [
			   		{
						iconCls:"icon-add",
						text:"检测科目数据更新",
						handler:function(){
							$.messager.confirm("确认","您是否确认检测科目数据更新?",function(r){
								if(!r)return;
								dg1.datagrid("load",{"action":"1"});
							});
						}
					},
					{
						iconCls:"icon-reload",
						text:"更新到表",
						handler:function(){
							$.messager.confirm("确认","您是否确认更新数据?",function(r){
								if(!r)return;
								var rows = dg1.datagrid("getChecked");
								if(!rows ||rows.length == 0){
									$.messager.alert("提示","请选择要更新的数据");
								}
								$.ajax({
									url:"<@s.url '/admin/update/subject/update'/>",
									type:"post",
									data:{"subjects":rows},
									dataType:"json",
									success:function(data){
										if(data.success){
											$.messager.show("提示","更新成功");
										}
									}
								});
							});
						}
					}
					],
			onLoadError:function(e){
				<@error_dialog "e"/>
			},
			onCheck:function(index,data){
				if(data.status == "旧的"){
					dg1.datagrid("uncheckRow",index);	//取消选择
				}
			}
		});
		//dg
		var dg = $("#${dg}").datagrid({
			url : "<@s.url '/admin/local/subject/datagrid'/>",
			fit : true,
			fitColumns : true,
			rownumbers : true,
			pagination : true,
			pagePosition : "bottom",
			pageSize : 20,
			pageList : [ 20, 30, 40 ],
			border : true,
			striped : true,
			idField : "code",
			sortName : "id",
			sortOrder : "asc",
			columns : [ [ {
				field : "check",
				checkbox : true
			}, {
				title : "科目代码",
				field : "code",
				width : 10,
				align : "left",
				sortable : true
			}, {
				title : "科目名称",
				field : "name",
				width : 40,
				align : "left",
				sortable : true
			}, {
				title : "所属考试类别",
				field : "catalogName",
				width : 20,
				align : "left"
			} ] ],
			toolbar : "#${dg}_toobar",
			onLoadError : function(e) {
				<@error_dialog "e"/>
			}
		});
		//search
		${dg}_search = function() {
			dg.datagrid("load", {
				name : $("#${dg}_toobar input[name='name']").val(),
				catalogId : current_catalog_id,
			});
		};
		//导入班级数据
		${dg}_add = function() {
			if (!current_catalog_id) {
				$.messager.alert("提示", "请先选择环球的分类");
				return;
			}
			$.messager.confirm("确认", "您是否确认初始化科目数据?", function(r) {
				if (!r)
					return;
				$.messager.progress();
				$.ajax({
					url : "<@s.url '/admin/local/subject/init'/>",
					type : "POST",
					data : {
						"catalogId" : current_catalog_id
					},
					dataType : "json",
					error : function(e) {
						$.messager.progress("close");
						<@error_dialog "e"/>
					},
					success : function(data, textStatus) {
						$.messager.progress("close");
						if (data.success) {
							dg.datagrid("load");
							dg.datagrid("unselectAll");
							$.messager.show({
								title : '提示',
								msg : '班级数据导入成功',
								showType : 'show'
							});
						} else {
							$.messager.show({
								title : "提示",
								msg : data.msg
							});
						}
					}
				});
			});
		};
	});
//-->
</script>
<div class="easyui-layout" data-options="fit:true" id="${dg}_layout">
	<div
		data-options="region:'west',title:'班级更新',split:true"	style="width: 450px;">
		<table id="${dg}_remote"></table>
	</div>
	<div data-options="region:'center',title:'科目列表'">
		<div class="easyui-layout" data-options="fit:true" id="${dg}_layout">
			<div
				data-options="region:'west',title:'所属考试',split:true,tools: [{
		 		iconCls:'icon-reload',
		 		handler:function(){
			 		$('#${module}_list_catalog_exam_tree').tree('reload');
			 		${dg}_search();
		 		}
	 			}]"
				style="padding: 5px; width: 190px;">
				<ul id="${module}_list_catalog_exam_tree"></ul>
			</div>
			<div data-options="region:'center',title:'科目列表'">
				<table id="${dg}"></table>
				<div id="${dg}_toobar">
					<a href="#" class="easyui-linkbutton" onclick="${dg}_add()"
						data-options="iconCls:'icon-add',plain:true" style="float: left;">导入数据</a>
					<label>科目名称:</label> <input name="name" type="text"
						style="width: 198px;" /> <a href="#" class="easyui-linkbutton"
						style="margin-left: 10px;" onclick="${dg}_search()"
						data-options="iconCls:'icon-search',plain:true">查询</a>
				</div>
			</div>
		</div>
	</div>
</div>